name: Generate Client

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Install tools
        run: make install-tools

      - name: Generate client
        run: make generate

      - name: Verify build
        run: make verify

      - name: Get version
        id: version
        run: echo "version=$(cat POCKET_ID_VERSION | tr -d '\n')" >> $GITHUB_OUTPUT

      - name: Create release from orphan branch
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Create orphan branch with only the generated code
          git checkout --orphan "${VERSION}"

          # Remove everything from index
          git rm -rf --cached .

          # Add only the files needed for the Go module
          git add -f go.mod go.sum client/ models/ swagger.yaml

          git commit -m "Generated client from Pocket ID ${VERSION}"

          # Delete existing tag/release if they exist
          gh release delete "$VERSION" --yes 2>/dev/null || true
          git push origin ":refs/tags/$VERSION" 2>/dev/null || true
          git push origin ":refs/heads/$VERSION" 2>/dev/null || true

          # Tag and release
          git tag -f "$VERSION"
          git push origin "HEAD:refs/heads/${VERSION}" --force
          git push origin "refs/tags/${VERSION}" --force

          gh release create "$VERSION" \
            --title "Pocket ID $VERSION" \
            --notes "Generated from [Pocket ID $VERSION](https://github.com/pocket-id/pocket-id/releases/tag/$VERSION)
